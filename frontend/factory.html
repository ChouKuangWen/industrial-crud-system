<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>工廠資料 CRUD 系統</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body class="p-4">
  <div class="container">
    <h2 class="mb-4">工廠資料管理系統</h2>

    <!-- 🚦 CRUD 操作選單 -->
    <div class="mb-4">
      <label class="form-label">請選擇操作：</label>
      <select id="crudSelect" class="form-select" onchange="switchMode()">
        <option value="">-- 請選擇 --</option>
        <option value="create">C - 新增工廠</option>
        <option value="read">R - 查詢工廠</option>
        <option value="update">U - 修改工廠</option>
        <option value="delete">D - 刪除工廠</option>
      </select>
    </div>

    <!-- ✅ C：新增 -->
    <div id="createBox" class="crud-box" style="display:none">
      <h4>➕ 新增工廠</h4>
      <input id="c_name" class="form-control mb-2" placeholder="工廠名稱">
      <input id="c_location" class="form-control mb-2" placeholder="地址">
      <input id="c_phone" class="form-control mb-2" placeholder="聯絡電話">
      <input id="c_employee_count" type="number" class="form-control mb-2" placeholder="員工人數">
      <input id="c_established_date" type="date" class="form-control mb-2" placeholder="成立日期">
      <button class="btn btn-primary" onclick="createFactory()">新增</button>
    </div>

    <!-- 🔍 R：查詢 -->
    <div id="readBox" class="crud-box" style="display:none">
      <h4>🔍 查詢工廠</h4>
      <input id="r_keyword" class="form-control mb-2" placeholder="輸入工廠名稱關鍵字">
      <button class="btn btn-secondary mb-2" onclick="readFactories()">查詢</button>
      <table class="table table-bordered">
        <thead><tr><th>ID</th><th>名稱</th><th>地址</th><th>電話</th><th>員工人數</th><th>成立日期</th></tr></thead>
        <tbody id="readTable"></tbody>
      </table>
    </div>

    <!-- 📝 U：修改 -->
    <div id="updateBox" class="crud-box" style="display:none">
      <h4>📝 修改工廠</h4>
      <input id="u_id" class="form-control mb-2" placeholder="輸入欲修改工廠ID">
      <button class="btn btn-warning mb-3" onclick="loadUpdateFactory()">載入資料</button>
      <div id="updateForm" style="display:none">
        <input id="u_name" class="form-control mb-2" placeholder="工廠名稱">
        <input id="u_location" class="form-control mb-2" placeholder="地址">
        <input id="u_phone" class="form-control mb-2" placeholder="聯絡電話">
        <input id="u_employee_count" type="number" class="form-control mb-2" placeholder="員工人數">
        <input id="u_established_date" type="date" class="form-control mb-2" placeholder="成立日期">
        <button class="btn btn-success" onclick="updateFactory()">儲存修改</button>
      </div>
    </div>

    <!-- ❌ D：刪除 -->
    <div id="deleteBox" class="crud-box" style="display:none">
      <h4>❌ 刪除工廠</h4>
      <input id="d_id" class="form-control mb-2" placeholder="輸入工廠ID">
      <button class="btn btn-danger" onclick="deleteFactory()">刪除</button>
    </div>
  </div>

  <script>
    const api = "http://localhost:8000/factories";

    function switchMode() {
      document.querySelectorAll(".crud-box").forEach(box => box.style.display = "none");
      const mode = document.getElementById("crudSelect").value;
      if (mode) document.getElementById(mode + "Box").style.display = "block";
    }

    async function createFactory() {
      const factory = {
        name: document.getElementById("c_name").value,
        location: document.getElementById("c_location").value,
        phone: document.getElementById("c_phone").value,
        employee_count: parseInt(document.getElementById("c_employee_count").value) || 0,
        established_date: document.getElementById("c_established_date").value
      };
      try {
        await axios.post(api, factory);
        alert("✅ 新增成功");
      } catch (err) {
        alert("❌ 錯誤：" + (err.response?.data?.detail || err.message));
      }
    }

    async function readFactories() {
      const keyword = document.getElementById("r_keyword").value.toLowerCase();
      const res = await axios.get(api);
      const table = document.getElementById("readTable");
      table.innerHTML = "";
      res.data.forEach(f => {
        if (f.name.toLowerCase().includes(keyword)) {
          table.innerHTML += `<tr>
            <td>${f.factory_id}</td><td>${f.name}</td>
            <td>${f.location || ""}</td><td>${f.phone || ""}</td>
            <td>${f.employee_count}</td><td>${f.established_date || ""}</td>
          </tr>`;
        }
      });
    }

    async function loadUpdateFactory() {
      const id = document.getElementById("u_id").value;
      try {
        const res = await axios.get(`${api}/${id}`);
        const f = res.data;
        document.getElementById("u_name").value = f.name;
        document.getElementById("u_location").value = f.location;
        document.getElementById("u_phone").value = f.phone;
        document.getElementById("u_employee_count").value = f.employee_count;
        document.getElementById("u_established_date").value = f.established_date || "";
        document.getElementById("updateForm").style.display = "block";
      } catch (err) {
        alert("❌ 找不到工廠");
        document.getElementById("updateForm").style.display = "none";
      }
    }

    async function updateFactory() {
      const id = document.getElementById("u_id").value;
      const factory = {
        name: document.getElementById("u_name").value,
        location: document.getElementById("u_location").value,
        phone: document.getElementById("u_phone").value,
        employee_count: parseInt(document.getElementById("u_employee_count").value) || 0,
        established_date: document.getElementById("u_established_date").value
      };
      try {
        await axios.put(`${api}/${id}`, factory);
        alert("✅ 修改成功");
      } catch (err) {
        alert("❌ 修改失敗：" + err.message);
      }
    }

    async function deleteFactory() {
      const id = document.getElementById("d_id").value;
      if (!confirm(`確定要刪除工廠 ID ${id} 嗎？`)) return;
      try {
        await axios.delete(`${api}/${id}`);
        alert("✅ 刪除成功");
      } catch (err) {
        alert("❌ 刪除失敗：" + err.message);
      }
    }
  </script>
</body>
</html>
